<!-- Test-Styles einbinden -->
<style>
  <% @test.style_files.each do |f| %>
  <%= raw f.download.force_encoding('UTF-8') %>
  <% end %>
</style>

<!-- Hauptseite rendern -->
<%= raw @test.entry_point.download.force_encoding('UTF-8') %>

<!-- Testskripte laden und Testumgebund definieren -->
<script>
    //Medienpfade für Test bekannt machen (aus ActiveStorage)
    var media_paths = {
        <% @test.media_files.each do |f| %>
        '<%= f.filename %>': '<%= url_for(f) %>',
        <% end %>
    };

    <% if !@result.prior_result_id.nil? %>
    <% last_result = 0 %>
    <% Result.find(@result.prior_result_id).data.each do |data| %>
        <% if data["result"]=='NA'%>
        <% else %>
          <% last_result += data["result"]%>
        <% end %>
      <% end %>
    <% else %>
      <% last_result = -1 %>
    <% end %>
    var lastResult = <%= last_result %>;

    //Funktionen für Testumgebung bereitstellen
    function saveResults(result, data) {
        fetch('<%= student_result_url(@student, @result) %>', {
            method: 'put',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
            },
            credentials: 'include',
            body: 'results=' + encodeURIComponent(JSON.stringify(result)) + '&data=' + encodeURIComponent(JSON.stringify(data))
        });
    }

    //Testfenster schließen
    function exit() {
        <% if @test.student_test %>
          window.location.href = '/testen';
        <% else %>
          window.location.href = '<%= group_assessment_path(@result.student.group, @test) %>';
        <% end %>
    }

    var stopwatch = null;
    function startTimer() {
        stopwatch = new Date();
    }

    function stopTimer() {
        return (new Date() - stopwatch)
    }

    //Test-Skripte einbinden
    <% @test.script_files.each do |f| %>
    <%= raw f.download.force_encoding('UTF-8') %>
    <% end %>

</script>