<!-- Test-Styles einbinden -->
<style>
  <% @test.style_files.each do |f| %>
  <%= raw f.download.force_encoding('UTF-8') %>
  <% end %>
</style>

<!-- Hauptseite rendern -->
<%= raw @test.entry_point.download.force_encoding('UTF-8') %>

<!-- Testskripte laden und Testumgebund definieren -->
<script>
    //Medienpfade für Test bekannt machen (aus ActiveStorage)
    media_paths = {
        <% @test.media_files.each do |f| %>
        '<%= f.filename %>': '<%= url_for(f) %>',
        <% end %>
    };

    //Funktionen für Testumgebung bereitstellen
    function saveResults(result, data) {
        fetch('<%= student_result_url(@student, @result) %>', {
            method: 'put',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
            },
            credentials: 'include',
            body: 'results=' + encodeURIComponent(JSON.stringify(result)) + '&data=' + encodeURIComponent(JSON.stringify(data))
        })
            .then(response => exit());
    }

    <% unless @test.student_test %>
      //Testfenster schließen
      function exit() {
          window.close();
      }
    <% end %>

    //Test-Skripte einbinden
    <% @test.script_files.each do |f| %>
    <%= raw f.download.force_encoding('UTF-8') %>
    <% end %>

</script>