<script>
    <% if @masquerade %>
      masquerade = true
    <% else %>
      masquerade = false
    <% end %>
    //TODO: woanders? Teil von Webpack?
    <%
      #Schülernamen und Gruppen-Keys verfügbar machen
      groups = {}
      keys = {}

      unless @login.nil?
        @login.students.each do |s|
          groups[s.group_id] ||= []
          groups[s.group_id] += [s]
        end
        @login.group_shares.each do |c|
          keys[c.group_id] = c.key
        end
      end

   %>

    groups = JSON.parse("<%= escape_javascript(raw groups.to_json)%>")
    keys = JSON.parse("<%= escape_javascript(raw keys.to_json)%>")

    //Entschlüsselt einen String mit dem im sessionStorage gespeicherten "Masterkey" und dem Key der Gruppe
    // Falls die Entschlüsselung fehlschlägt, wird der Wert von alt zurückgegeben.
    function decrypt(text, alt, group) {
        let res = ''
        try {
            let tempkey = sjcl.decrypt(sessionStorage['login'], keys[group])
            res = sjcl.decrypt(tempkey, text)
        }
        catch(e) {
            console.error(e.toString())
            console.log('Entschlüsselung fehlgeschlagen') //Log-Output (evtl. nicht in Production?)
            res = alt
        }
        return res;
    }

    //Verschlüsselt einen String mit dem im sessionStorage gespeicherten "Masterkey" und dem Key der Gruppe.
    function encrypt(text, group) {
        let tempkey = sjcl.decrypt(sessionStorage.getItem('login'), keys[group])
        return sjcl.encrypt(tempkey, text)
    }

    //Entschlüsselt einen String mit dem im sessionStorage gespeicherten "Masterkey"
    function decrypt_key(text) {
        if (!text){
            return ''
        }
        let res = ''
        try {
            res = sjcl.decrypt(sessionStorage.getItem('login'), text)
        }
        catch(e){
            console.error(e.toString())
            console.log('Entschlüsselung fehlgeschlagen') //Log-Output (evtl. nicht in Production?)
            res = ''
        }
        return res
    }

    //Verschlüsselt einen String mit dem im sessionStorage gespeicherten "Masterkey".
    function encrypt_key(text) {
        if (!text){
            return null
        }
        return sjcl.encrypt(sessionStorage.getItem('login'), text)
    }

    //Liefert das Student-Objekt zu einer ID in dessen Gruppe zurück.
    function get_student(group, id) {
        for (let j = 0; j < groups[group].length; ++j)
            if (groups[group][j].id == id)
                return groups[group][j]
        return null
    }

    function recode_keys(new_password) {
        // decrypt keys with current password
        const new_keys = Object.entries(keys).map(k=> ({id: k[0], key:  decrypt_key(k[1])}))

        // update login data
        sessionStorage['old_login'] = sessionStorage['login']
        sessionStorage['login'] = new_password

        // recode with new password, update in global namespace
        keys = Object.entries(keys).map(k=> ({id: k[0], key:  encrypt_key(k[1])}))
    }

    //Namen der Schüler entschlüsseln, evtl. nicht bei jedem Reload?
    // TODO groups and students need to be in global store instead of the global namespace
    if (sessionStorage['login'] != undefined) {
        Object.keys(groups).forEach(function(key, index) {
            for (let i = 0; i < this[key].length; ++i)
                this[key][i].name = decrypt(this[key][i].name, 'Kind_' + this[key][i].id, key)
            //Nach Namen sortieren
            this[key].sort(function(a, b){return a.name < b.name ? -1 : a.name > b.name ? 1 : 0})
        }, groups)

    }
    else
        if (window.location != "https://www.levumi.de")
          window.location.replace("https://www.levumi.de")     //Ohne Passwort, zurück zum Login (z.B. durch Tab)
</script>
