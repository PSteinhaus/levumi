<template>
  <div id="niveau-overview">
    <b-container id="niv-container" class="mb-3" fluid>
      <template v-for="n in niveauArray">
        <b-row :key="n" cols="3" class="niveau" :style="styleForLevel(n)">
          <b-col cols="2" class="l-niv">
            <span class="niv-name" style="display: flex; align-items: end; white-space: nowrap;">{{"Niveau " + n}}</span>
            <div id="normal-container" style="width: 100%; height: 100%">
              <svg
                  v-if="n === niveauArray[0]"
                  class="normal-dist"
                  width="100%"
                  :height="overviewHeight + 'px'"
                  :viewBox="'0 '+ normalShift * 119.85765 +' 21.41 119.85765'"
                  preserveAspectRatio=none
              >
                <defs
                    id="defs73643">
                <linearGradient
                    id="linearGradient7580">
                  <stop
                      id="stop7576"
                      style="stop-color:#e5e5e5;stop-opacity:0.6;"
                      offset="0" />
                  <stop
                      id="stop7578"
                      style="stop-color:#ffffff;stop-opacity:0.5;"
                      offset="1" />
                </linearGradient>
                <linearGradient
                    id="linearGradient7582"
                    xlink:href="#linearGradient7580"
                    x1="0"
                    y1="59.928831"
                    x2="21.959299"
                    y2="59.928831"
                    gradientUnits="userSpaceOnUse" />
                </defs>
                <path
                    id="polyline21800"
                    style="fill:#ffffff;fill-opacity:0.5;stroke:#d2d2d2;stroke-width:0.357;stroke-linejoin:round;stroke-miterlimit:10;stroke-dasharray:none;stroke-opacity:1"
                    d="m 21.6308,119.85684 -0.003,-1.1994 -0.004,-1.19649 -0.004,-1.19941 -0.007,-1.19941 -0.009,-1.1965 -0.0101,-1.19939 -0.0144,-1.19941 -0.018,-1.1994 -0.0232,-1.1965 -0.0291,-1.1994 -0.0366,-1.1994 -0.0455,-1.19651 -0.0567,-1.19941 -0.0701,-1.19939 -0.0858,-1.1965 -0.10456,-1.19939 -0.12616,-1.199403 -0.15088,-1.1994 -0.18001,-1.19651 -0.21212,-1.1994 -0.24797,-1.199405 -0.28907,-1.196503 -0.33386,-1.199402 -0.38242,-1.199394 -0.43396,-1.199401 -0.48998,-1.196504 -0.54748,-1.199401 -0.60722,-1.199402 -0.66775,-1.196502 -0.72825,-1.199401 -0.78723,-1.199401 -0.84402,-1.196502 -0.89554,-1.199401 -0.94112,-1.199399 -0.9792,-1.199402 -1.00907,-1.196503 -1.0270101,-1.199401 -1.03299,-1.199399 -1.027,-1.196504 -1.00534,-1.1994 -0.97022,-1.1994 -0.9187,-1.199401 -0.85372,-1.196503 -0.7738,-1.199399 -0.68044,-1.199401 -0.57513,-1.196504 -0.45860995,-1.199399 -0.33387,-1.199401 -0.2024,-1.196504 -0.0687,-1.1994 0.0687,-1.1994 0.2024,-1.199402 0.33387,-1.196502 0.45860995,-1.199399 0.57513,-1.199401 0.68044,-1.196503 0.7738,-1.199401 0.85372,-1.1994 0.9187,-1.199401 0.97022,-1.196503 1.00534,-1.1994 1.027,-1.1994 1.03299,-1.196505 1.0270101,-1.199399 1.00907,-1.1994 0.9792,-1.1994 0.94112,-1.196503 0.89554,-1.199401 0.84402,-1.1994 0.78723,-1.196504 0.72825,-1.199399 0.66775,-1.199401 0.60722,-1.196504 0.54748,-1.1994 0.48998,-1.1994 0.43396,-1.1994 0.38242,-1.196503 0.33386,-1.199401 0.28907,-1.1994 0.24797,-1.196503 0.21212,-1.199401 0.18001,-1.1994 0.15088,-1.1994 0.12616,-1.196504 0.10456,-1.199401 0.0858,-1.199398 0.0701,-1.196504 0.0567,-1.199401 0.0455,-1.1994 0.0366,-1.196503 0.0291,-1.199401 0.0232,-1.1994002 0.018,-1.1994 0.0144,-1.196503 0.0101,-1.199401 0.009,-1.1993999 0.007,-1.1965033 0.004,-1.1994003 0.004,-1.1994003 0.003,-1.19940034194" />
              </svg>
            </div>
          </b-col>
          <b-col cols="6" lg="7" class="t-examples">
            <template v-for="(example, key) in examplesForLevel(n)">
              <div :key="key" class="example-div">
                <span v-for="(line, lineKey) in example.lines" :key="lineKey" style="display: block">
                  <span v-for="(part, partKey) in line" :key="partKey" style="display: inline-flex; vertical-align: middle">
                    <div v-if="part.type === 'text-fraction'" class="fraction">
                      <p class="numerator">{{part.numerator}}</p>
                      <p class="denominator">{{part.denominator}}</p>
                    </div>
                    <span v-else-if="part.type === 'plain-text'" style="display: inline-flex">{{part.text}}</span>
                  </span>
                </span>
                <img  v-if="example.image !== undefined" class="example-img" :src="example.image.filepath" :alt="'eine Beispielaufgabe für das Niveau' + n">
              </div>
            </template>
          </b-col>
          <b-col cols="4" lg="3" class="headline-col">
            <span class="explanation-tooltip">{{explanationForLevel(n)}}</span>
            <span class="headline">{{headlineForLevel(n)}}</span>
          </b-col>
        </b-row>
      </template>
    </b-container>
  </div>
</template>

<script>

const A = 'Anforderungsstufen'
const E = '_example'

export default {
  name: 'NiveauOverview',
  inject: ['testData'],
  props: {
    nivConfig: Object
  },
  data: function () {
    return {
      nivColors: [
        "#c6d3ec",
        "#b2efb2",
        "#ffffb2",
        "#ffebb2",
        "#ffb2b2"
      ],
      nivTextColors: [
        "#4270c2",
        "#00b04f",
        "#ffbf00",
        "#eb7d30",
        "#bf0000"
      ],
      loaded: false
    }
  },
  computed: {
    exampleImages() {
      return this.testData?.info_attachments.filter(
          attachment => attachment.content_type.startsWith('image') && attachment.filename.startsWith(A + E)
      )
    },
    /** A decreasing list of niveau numbers, such as [4,3,2,1] for 4 niveaus. */
    niveauArray() {
      const nivCount = this.nivConfig.heights.length
      return [...Array(nivCount).keys()].map(x => x+1).reverse()
    },
    overviewHeight() {
      if (this.loaded) {
        return document.getElementById("niv-container")?.clientHeight
      }
      return 1000
    },
    /** A percentage value determining how much the normal should be shifted upwards from its middle position. */
    normalShift() {
      return this.nivConfig.normal_shift / 100
    }
  },
  mounted() {
    this.loaded = true
  },
  methods: {
    examplesForLevel(level) {
      const example_texts = this.nivConfig.example_texts[level-1]
      const example_images = this.exampleImages.filter(img => img.filename.startsWith(A + E + level))
      // build examples from texts, adding images where appropriate
      let i = 1
      return example_texts.map(text => {
        // search for a corresponding image
        const image = example_images.find(img => img.filename.startsWith(A + E + level + "_" + i))
        // first break the text into lines
        const lines = text.split("\n")
        // search the text for incidences of \S+⌹\S+ and split it there, keeping the separator
        const fracRegex = /(\S+⌹\S+)/
        for (let j = 0; j < lines.length; ++j) {
          let k = -1
          lines[j] = lines[j]
              .split(fracRegex)
              // map this to an array of objects that are either of a 'plain-text' or 'fraction' type
              .map(s => {
                ++k
                if (fracRegex.test(s)) {
                  const slots = s.split('⌹')
                  return {type: 'text-fraction', id: k, numerator: slots[0], denominator: slots[1]}
                } else {
                  return {type: 'plain-text', id: k, text: s}
                }
              })
        }
        ++i
        return {lines: lines, image: image}
      })
    },
    headlineForLevel(level) {
      return this.nivConfig.headlines[level-1]
    },
    styleForLevel(level) {
      return {
        'color': this.nivTextColors[level-1],
        'background-color': this.nivColors[level-1],
        'height': this.nivConfig.heights[level-1]
      };
    },
    explanationForLevel(level) {
      return this.nivConfig.explanations[level-1]
    },
  },
}
</script>

<style>
#niveau-overview {
  width: 100%;
  //height: 38vw;
  margin: 2.3rem;
  font-weight: bold;
}
@media (max-width: 1400px) {
  #niveau-overview {
    margin: 2.3rem 1.15rem;
  }
}
@media (max-width: 992px) {
  #niveau-overview {
    margin: 2.3rem 0.5rem;
  }
}
#niv-container {
  height: 100%;
  max-width: 1800px;
  max-height: 1000px;
}
.niveau {
  //border-radius: 12px!important;
  //padding: 3px;
  border: 0 solid #b9b9b9;
  border-bottom-width: 1px;
}
.niveau:first-child {
  border-radius: 8px 8px 0 0;
}
.niveau:last-child {
  border-radius: 0 0 8px 8px;
  border-width: 0;
}
.t-examples {
  padding: 0 !important;
  display: flex;
  flex-wrap: wrap;
  flex-direction:column;
  background-color: white;
  color: black;
  height: 100%;
  max-width: 100%;
  overflow: scroll;
  //border-radius: 6px;
}
.l-niv {
  flex-wrap: nowrap;
  height: 100%;
  padding: 0 0 0 0.6rem !important;
  position: relative;
  display: flex;
}
@media (max-width: 892px) {
  .niv-name {
    align-self: center;
    writing-mode: vertical-rl;
    text-orientation: upright;
    margin-right: 3px;
  }
}
.headline-col {
  display: flex;
  padding: 0.2rem;
  position: relative;
  height: 100%;
}
.headline {
  display: flex;
  align-self: center;
  max-height: 100%;
  overflow: scroll;
}
.example-div {
/* take up half the space, leading to two columns of examples being shown */
  display: flex;
  flex-flow: column;
  width: 50%;
  max-height: 100%;
  padding: 10px 1em;
  font-weight: normal;
  white-space: pre-wrap;
}
@media (max-width: 992px) {
  .example-div {
    /* take up the full space, leading to only one column of examples being shown */
    width: 100%;
  }
}
.example-img {
  padding-top: 4px;
  padding-bottom: 0;
  margin-left: auto;
  margin-right: auto;
  object-fit: contain;
  width: auto;
  max-width: 100%;
  min-height: 0;
  max-height: 100%;
}
.explanation-tooltip {
  left: -0.1rem;
  top: 0;
  white-space: pre-wrap;
  background-color: #f5f5f5;
  color: black;
  font-weight: 400;
  border: 1px solid rgba(0, 0, 0, 0.225);
  border-radius: 4px;
  padding: 11px;
  position: absolute;
  width: 115%;
  transform: translate(-100%, 0%);
  visibility: hidden;
  z-index: 999;
  opacity: 0;
  transition: opacity 0.4s;
}
@media (max-width: 1150px) {
  .explanation-tooltip {
    width: 200%;
  }
}
.headline-col:hover .explanation-tooltip {
  visibility: visible;
  opacity: 1;
}
.fraction {
  display: inline-grid;
  width: max-content;
  font-size: 75%;
  margin: 1pt;
  text-align: center;
}
.numerator {
  border-bottom: 1px solid black;
  padding-left: 2pt;
  padding-right: 2pt;
  margin: 0 2pt 0;
}
.denominator {
  border-top: 1px solid black;
  padding-left: 2pt;
  padding-right: 2pt;
  margin: 0 2pt 0;
}
</style>
